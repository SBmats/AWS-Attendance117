<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Student & Admin Portal — Glass UI</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --accent:#0d6efd; --accent-dark:#0a58ca; --glass-bg: rgba(255,255,255,0.55);
      --glass-border: rgba(255,255,255,0.6); --card-shadow: 0 10px 30px rgba(13,40,70,0.08);
      --text:#153047; --muted:#567085; --success: #1b8a3e; --danger: #d9534f; --amber: #f59e0b;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:"Inter",system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
      background: radial-gradient(1200px 400px at 10% 10%, #e6f0ff 0%, transparent 20%),
                  radial-gradient(900px 300px at 95% 90%, #fff6f0 0%, transparent 10%),
                  linear-gradient(180deg,#eef7ff 0%, #ffffff 100%);
      color:var(--text);display:flex;justify-content:center;align-items:flex-start;padding:40px 20px;}
    .container{width:100%;max-width:980px;}
    header{display:flex;flex-direction:column;align-items:center;gap:16px;margin-bottom:28px;}
    .brand{display:flex;gap:12px;align-items:center;}
    .logo{width:44px;height:44px;border-radius:8px;
      background:linear-gradient(135deg,#6ec1ff,#6ef5c4 70%,#ffd36e);display:flex;align-items:center;justify-content:center;
      box-shadow:0 6px 18px rgba(13,40,70,0.08);transform:rotate(-8deg);}
    .logo svg{width:28px;height:28px;}
    h1{margin:0;font-size:1.9rem;color:var(--accent-dark);letter-spacing:0.2px;}
    .top-actions{display:flex;gap:12px;margin-top:6px;}
    .btn{background:linear-gradient(180deg,var(--accent),var(--accent-dark));border:none;color:white;padding:10px 16px;
      border-radius:10px;cursor:pointer;box-shadow:0 6px 18px rgba(13,40,70,0.08);font-weight:600;transition:transform .14s ease, box-shadow .14s ease;}
    .btn:hover{transform:translateY(-3px);box-shadow:0 18px 30px rgba(13,40,70,0.12);}
    .btn.secondary{background:transparent;color:var(--accent-dark);border:1px solid rgba(13,40,70,0.06);}
    #app{margin:0 auto;padding:28px;border-radius:14px;background:linear-gradient(180deg,rgba(255,255,255,0.56),rgba(255,255,255,0.48));
      border:1px solid var(--glass-border);backdrop-filter:blur(8px) saturate(120%);box-shadow:var(--card-shadow);max-width:760px;min-height:240px;}
    .form-row{margin:12px 0;display:flex;gap:12px;justify-content:center;flex-wrap:wrap;}
    input[type="text"],input[type="password"],input[type="file"],select{
      width:260px;padding:12px 14px;border-radius:10px;border:1px solid rgba(21,48,71,0.08);
      box-shadow:0 4px 18px rgba(13,40,70,0.03) inset;font-size:15px;}
    .muted{color:var(--muted);font-size:14px;}
    hr.sep{border:0;border-top:1px solid rgba(21,48,71,0.06);margin:16px 0;}
    .q-card{margin-top:10px;padding:26px 30px;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,0.65),rgba(250,250,255,0.55));
      border:1px solid rgba(255,255,255,0.6);box-shadow:0 8px 24px rgba(13,40,70,0.06);display:flex;flex-direction:column;gap:20px;}
    .q-left{text-align:left;min-width:280px;}
    .q-left h3{margin:0 0 12px 0;color:var(--accent-dark);font-size:18px;}
    .options{display:flex;flex-direction:column;gap:8px;}
    .options label{display:flex;gap:12px;align-items:flex-start;padding:8px 12px;border-radius:8px;cursor:pointer;font-size:15px;color:var(--text);}
    .options input{margin-top:4px;}
    .options label:hover{background:rgba(13,40,70,0.03);transform:translateX(3px);}
    .next-row{margin-top:16px;display:flex;justify-content:space-between;align-items:center;gap:12px;}
    .info-pill{padding:8px 12px;border-radius:999px;background:rgba(13,40,70,0.04);color:var(--muted);font-weight:600;font-size:13px;}
    .small-btn{padding:8px 12px;border-radius:8px;border:1px solid rgba(13,40,70,0.06);background:white;cursor:pointer;}
    footer{margin-top:18px;color:var(--muted);font-size:13px;text-align:center;}
  </style>
</head>
<body>
<div class="container">
  <header>
    <div class="brand">
      <div class="logo" aria-hidden>
        <svg viewBox="0 0 24 24" fill="none"><rect x="3" y="6" width="18" height="12" rx="2" fill="white" opacity="0.9"/><rect x="5" y="8" width="6" height="1.8" rx="0.9" fill="#6ec1ff"/><rect x="13" y="8" width="6" height="1.8" rx="0.9" fill="#ffd36e"/></svg>
      </div>
      <div>
        <h1>Student & Admin Portal</h1>
        <div class="muted">Clean UI • No timer</div>
      </div>
    </div>
    <div class="top-actions">
      <button class="btn" onclick="studentLogin()">Student Login</button>
      <button class="btn secondary" onclick="adminLogin()">Admin Login</button>
    </div>
  </header>
  <main id="app">
    <div style="text-align:center; padding:28px;">
      <div style="font-weight:700; color:var(--accent-dark); font-size:18px;">Welcome — choose Student or Admin</div>
      <div class="muted" style="margin-top:10px;">Click <strong>Student Login</strong> to start or <strong>Admin Login</strong> to upload questions (.docx)</div>
    </div>
  </main>
  <footer>Built with ❤️ — glass UI</footer>
</div>
<script>
const app=document.getElementById('app');
function escapeHtml(s){return(s+'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}
function csvEscape(s){return '"' + String(s||'').replace(/"/g,'""') + '"';}
function studentLogin(){
  app.innerHTML=`<div class="form-row" style="flex-direction:column;align-items:center;">
  <h2 style="margin:0;color:var(--accent-dark)">Student Login</h2>
  <input id="name" placeholder="Full name" type="text" />
  <input id="roll" placeholder="Roll number" type="text" />
  <input id="branch" placeholder="Branch" type="text" />
  <input id="phone" placeholder="Phone number" type="text" />
  <button class="btn" onclick="saveStudent()">Login & Continue</button></div>`;
}
function saveStudent(){
  const student={name:document.getElementById('name').value||'Unknown',
    roll:document.getElementById('roll').value||('R'+Date.now().toString().slice(-5)),
    branch:document.getElementById('branch').value||'',
    phone:document.getElementById('phone').value||''};
  localStorage.setItem('currentStudent',JSON.stringify(student));
  studentDashboard();
}
function studentDashboard(){
  const s=JSON.parse(localStorage.getItem('currentStudent'));
  if(!s) return studentLogin();
  const results=JSON.parse(localStorage.getItem('allResults')||'[]');
  const myResults=results.filter(r=>r.roll===s.roll);
  const top=[...results].sort((a,b)=>b.score-a.score)[0];
  app.innerHTML=`<div style="text-align:center">
    <h2 style="color:var(--accent-dark)">Welcome ${escapeHtml(s.name)} (${escapeHtml(s.roll)})</h2>
    <button class="btn" onclick="startExam()">Start Exam</button>
    <h3>Your Results</h3>
    ${myResults.length?myResults.map((r,i)=>`<p>Attempt ${i+1}: <strong>${r.score}/${r.total}</strong></p>`).join(''):'<p>No attempts yet.</p>'}
    <h3>Topper</h3>
    <p>${top?escapeHtml(top.name)+' - '+top.score+'/'+top.total:"No data yet."}</p>
    <button class="small-btn" onclick="downloadAllResultsCSV()">Download All Results (CSV)</button></div>`;
}
function adminLogin(){
  app.innerHTML=`<div style="text-align:center">
    <h2 style="color:var(--accent-dark)">Admin Login</h2>
    <input id="adminPass" type="password" placeholder="Password" />
    <button class="btn" onclick="checkAdmin()">Login</button>
    <div class="muted">Default pass: <strong>admin123</strong></div></div>`;
}
function checkAdmin(){
  if(document.getElementById('adminPass').value==='admin123'){localStorage.setItem('adminLoggedIn','1');adminPanel();}
  else alert('Wrong password');
}
function adminPanel(){
  if(!localStorage.getItem('adminLoggedIn')) return adminLogin();
  const qCount=JSON.parse(localStorage.getItem('questions')||'[]').length;
  app.innerHTML=`<div style="text-align:center">
    <h2>Admin Panel</h2>
    <input id="docxFile" type="file" accept=".docx" />
    <button class="btn" onclick="uploadQuestions()">Upload Questions (.docx)</button>
    <hr class="sep" />
    <button class="small-btn" onclick="downloadAllResultsCSV()">Download Results (CSV)</button>
    <button class="small-btn" onclick="clearResults()">Clear All Results</button>
    <button class="small-btn" onclick="clearQuestions()">Clear All Questions</button>
    <div class="muted">Current bank: <strong>${qCount}</strong> questions.</div></div>`;
}
function clearResults(){if(confirm('Clear all student results?')){localStorage.removeItem('allResults');adminPanel();}}
function clearQuestions(){if(confirm('Clear uploaded questions?')){localStorage.removeItem('questions');adminPanel();}}
async function uploadQuestions(){
  const file=document.getElementById('docxFile').files[0];
  if(!file) return alert('Select a .docx file');
  try{
    const arrayBuffer=await file.arrayBuffer();
    const res=await mammoth.extractRawText({arrayBuffer});
    const parts=res.value.split(/\n?\d+\.\s+/).slice(1);
    const qList=parts.map(p=>{
      const lines=p.trim().split('\n').map(l=>l.trim()).filter(Boolean);
      const question=lines[0]||'Question';
      const options=[];
      for(let i=1;i<lines.length && options.length<4;i++){
        const m=lines[i].match(/^[A-Da-d][\)\.\-:\s]+\s*(.*)$/);
        options.push(m?m[1].trim():lines[i]);
      }
      while(options.length<4) options.push('Option');
      const ansLine=lines.find(l=>/^answer\s*[:]/i.test(l));
      const ans=ansLine?(ansLine.split(':')[1]||'').trim().toUpperCase().slice(0,1):'';
      return {question,options,answer:ans};
    }).filter(q=>q.question);
    const existing=JSON.parse(localStorage.getItem('questions')||'[]');
    const merged=existing.concat(qList);
    localStorage.setItem('questions',JSON.stringify(merged));
    alert(`${qList.length} questions uploaded.`);
    adminPanel();
  }catch(err){alert('Error parsing .docx.');}
}
function startExam(){
  const s=JSON.parse(localStorage.getItem('currentStudent'));
  const qList=JSON.parse(localStorage.getItem('questions')||'[]');
  if(!s) return studentLogin();
  if(qList.length<50) return alert("Need 50+ questions.");
  const exam=shuffleArray(qList).slice(0,50);
  let idx=0;const answers=[];
  renderQuestion();
  function renderQuestion(){
    const q=exam[idx];
    const optionsHtml=q.options.map((opt,i)=>{
      const letter=String.fromCharCode(65+i);
      return `<label><input type="radio" name="opt" value="${escapeHtml(letter)}"> ${escapeHtml(letter+') '+opt)}</label>`;
    }).join('');
    app.innerHTML=`<div class="q-card">
      <div class="q-left">
        <h3>Q${idx+1}. ${escapeHtml(q.question)}</h3>
        <div class="options">${optionsHtml}</div>
        <div class="next-row">
          <div class="info-pill">Question ${idx+1} of ${exam.length}</div>
          <button class="btn" id="nextBtn">Next</button>
        </div>
      </div></div>`;
    document.getElementById('nextBtn').onclick=saveAns;
  }
  function saveAns(){
    const sel=document.querySelector('input[name="opt"]:checked');
    const selected=sel?sel.value:'';
    const q=exam[idx];
    answers.push({question:q.question,selected,correct:q.answer});
    idx++;
    if(idx>=exam.length) finishExam();
    else renderQuestion();
  }
  function finishExam(){
    let score=0;
    const details=answers.map(a=>{if(a.selected===a.correct) score++; return a;});
    const results=JSON.parse(localStorage.getItem('allResults')||'[]');
    results.push({...s,score,total:exam.length,timestamp:Date.now(),details});
    localStorage.setItem('allResults',JSON.stringify(results));

    function generatePDF(){
      const {jsPDF}=window.jspdf;
      const doc=new jsPDF();
      let y=10;
      doc.setFontSize(14);
      doc.text(`Name: ${s.name}`,10,y); y+=8;
      doc.text(`Roll: ${s.roll}`,10,y); y+=8;
      doc.text(`Score: ${score}/${exam.length}`,10,y); y+=10;
      doc.setFontSize(12);
      details.forEach((a,i)=>{
        doc.text(`${i+1}. ${a.question}`,10,y); y+=6;
        doc.text(`Your Answer: ${a.selected || "Not answered"}`,12,y); y+=6;
        doc.text(`Correct Answer: ${a.correct}`,12,y); y+=6;
        doc.text(`Result: ${(a.selected===a.correct)?"Right":"Wrong"}`,12,y); y+=8;
        if(y>270){doc.addPage(); y=10;}
      });
      doc.save(`${s.roll}_result.pdf`);
    }

    app.innerHTML=`<div style="text-align:center">
      <h2>Exam Finished</h2>
      <p>Your score: ${score}/${exam.length}</p>
      <button class="btn" onclick="studentDashboard()">Back to Dashboard</button>
      <button class="btn secondary" onclick="(${generatePDF.toString()})();">Download PDF</button>
    </div>`;
  }
}
function downloadAllResultsCSV(){
  if(!localStorage.getItem('adminLoggedIn')) return alert('Admin login required');
  const data=JSON.parse(localStorage.getItem('allResults')||'[]');
  let csv="Name,Roll,Branch,Phone,Score,Total,Timestamp\n";
  data.forEach(d=>{csv+=`${csvEscape(d.name)},${csvEscape(d.roll)},${csvEscape(d.branch)},${csvEscape(d.phone)},${d.score},${d.total},${new Date(d.timestamp).toLocaleString()}\n`;});
  const blob=new Blob([csv],{type:'text/csv'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='results.csv';a.click();
}
function shuffleArray(arr){const a=arr.slice();for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}
(function init(){const s=JSON.parse(localStorage.getItem('currentStudent')||'null');if(s) studentDashboard();})();
</script>
</body>
</html>
